<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Visualization - Metagenome tutorial</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">Metagenome tutorial</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../startup/">Jupyter</a>
                    </li>
                
                
                
                    <li >
                        <a href="../qc/">QC</a>
                    </li>
                
                
                
                    <li >
                        <a href="../assembly/">Assembly</a>
                    </li>
                
                
                
                    <li >
                        <a href="../binning/">Binning</a>
                    </li>
                
                
                
                    <li class="active">
                        <a href="./">Visualization</a>
                    </li>
                
                
                
                    <li >
                        <a href="../hic/">HiC</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../binning/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../hic/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#visualization-of-metagenome-data">Visualization of metagenome data</a></li>
        
            <li><a href="#installing-anvio">Installing anvi'o</a></li>
        
            <li><a href="#preparing-data-for-anvio">Preparing data for anvi'o</a></li>
        
            <li><a href="#connecting-to-an-anvio-server">Connecting to an anvi'o server</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="visualization-of-metagenome-data">Visualization of metagenome data</h1>
<p>In this section we will explore ways to visualize the metagenomic data, with a view toward understanding the MAGs that we have reconstructed from our metagenomes.
For this we will use software called anvi'o, a highly versatile visualization and analysis environment for metagenomic (and pan-genomic) data.
The anvi'o software is extensively documented on <a href="http://merenlab.org/software/anvio/">the anvi'o website</a>, and rather than recapitulate all of that material here we will just go through the basic steps involved in getting our data loaded into anvi'o.
For further details on using the variety of features in anvi'o you can refer to the above site.</p>
<h2 id="installing-anvio">Installing anvi'o</h2>
<p>The simplest way to install anvi'o is via conda:</p>
<pre><code>conda create -n anvio5 -c bioconda -c conda-forge anvio=5.5.0
</code></pre>

<p>Notice this command is slightly different to our previous conda software installations, in this command we are invoking <code>conda create</code> which creates a new conda environment for anvi'o.
After the installation has completed, to use anvi'o we will first need to activate the environment with <code>conda activate anvio5</code>.</p>
<h2 id="preparing-data-for-anvio">Preparing data for anvi'o</h2>
<p>First we need to prepare our data for use in anvi'o.
Because we already have binning results from MetaBAT2 we will ask anvi'o to import those bins rather than computing new bins.
This will allow us to use anvi'o to browse the bins and interactively check and refine them as necessary.</p>
<pre><code>anvi-gen-contigs-database -f contigs-fixnames.fa -o contigs.db -n 'A gene school DB'
anvi-run-hmms -c contigs.db
for bam in `ls *.bam`; do anvi-profile -i $bam -c contigs.db; done
anvi-merge */PROFILE.db -o SAMPLES-MERGED -c contigs.db --skip-hierarchical-clustering
</code></pre>

<p>The above series of commands will take us from assembly contigs to a working anvi'o database, but there is a lot of compute along the way so if the data set is anything more than extremely trivial you will have to be <em>very patient</em>.
The pig metagenome timeseries dataset we are using in this tutorial will take 24 hours or more to process with the above commands.
Next, we need to create a file that will allow us to import our MetaBAT2 bins into anvi'o.
This is a pretty simple process:</p>
<pre><code>cd contigs-fixnames.fa.metabat-bins/
grep &quot;&gt;&quot; bin.*fa | perl -p -i -e &quot;s/(.+).fa:&gt;(.+)/\$2\t\$1/g&quot; &gt; ../binning_results.txt
cd ..
anvi-import-collection binning_results.txt -p SAMPLES-MERGED/PROFILE.db -c contigs.db --source &quot;MetaBAT2&quot;
</code></pre>

<p>The idea is to create a tab-delimited text file with two columns: the first is contig name and the second is the name of the bin that contig belongs to.
The command <code>grep "&gt;" bin.*fa</code> pulls out the contig names from each FastA bin file, and pipes the result to this command <code>perl -p -i -e "s/(.+).fa:&gt;(.+)/\$2\t\$1/g"</code> which is using a perl regular expression to extract the contig name (in $2) and bin name (in $1) and report them in two columns separated by the tab character <code>\t</code>.
The results are saved in a file called <code>binning_results.txt</code>.</p>
<h2 id="connecting-to-an-anvio-server">Connecting to an anvi'o server</h2>
<p>When used in interactive mode anvi'o is usually expected to be running locally on your own machine.
However, we are working on VMs in the cloud and so we need to start up an anvi'o server on our remote machine and then connect to it with our web browser.
Note that <em>this will only work with google chrome browser</em>. 
anvi'o's interactive mode does not currently work with any other browsers. 
You can try it of course but you're on your own when something goes wrong (which, in fact, could be said of almost anything in bioinformatics).</p>
<pre><code>anvi-interactive -p MERGED/PROFILE.db -c CONTIGS.db -s SAMPLES.db --server-only -P 8080 --password-protected
</code></pre></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
